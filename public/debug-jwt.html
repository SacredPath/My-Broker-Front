<!DOCTYPE html>
<html>
<head>
    <title>JWT Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .debug-section h3 { margin-top: 0; }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>JWT Token Debug Test</h1>
    <div id="debug-output"></div>
    
    <script src="/env.js"></script>
    <script type="module" src="/assets/js/authStateManager.js"></script>
    <script type="module" src="/assets/js/supabaseClient.js"></script>
    <script type="module" src="/assets/js/api.js"></script>
    <script type="module">
        const debugOutput = document.getElementById('debug-output');
        
        function addSection(title, content, className = 'info') {
            const section = document.createElement('div');
            section.className = `debug-section ${className}`;
            section.innerHTML = `
                <h3>${title}</h3>
                <pre>${JSON.stringify(content, null, 2)}</pre>
            `;
            debugOutput.appendChild(section);
        }
        
        async function debugJWT() {
            addSection('Starting JWT Debug Test', { timestamp: new Date().toISOString() });
            
            try {
                // Test 1: Check SupabaseClient availability
                addSection('SupabaseClient Check', {
                    available: !!window.SupabaseClient,
                    availableLegacy: !!window.supabase
                });
                
                // Test 2: Get Supabase client
                const supabase = window.SupabaseClient ? await window.SupabaseClient.getClient() : null;
                addSection('Supabase Client Retrieved', {
                    retrieved: !!supabase,
                    clientType: supabase ? 'SupabaseClient' : 'None'
                });
                
                if (!supabase) {
                    addSection('Error', { message: 'No Supabase client available' }, 'error');
                    return;
                }
                
                // Test 3: Get session
                const { data: { session } } = await supabase.auth.getSession();
                addSection('Session Retrieved', {
                    hasSession: !!session,
                    session: session ? {
                        hasAccessToken: !!session.access_token,
                        hasRefreshToken: !!session.refresh_token,
                        expiresAt: session.expires_at ? new Date(session.expires_at * 1000).toISOString() : null,
                        user: session.user ? {
                            id: session.user.id,
                            email: session.user.email
                        } : null
                    } : null
                });
                
                // Test 4: Check JWT token
                if (session?.access_token) {
                    const token = session.access_token;
                    addSection('JWT Token Analysis', {
                        tokenLength: token.length,
                        tokenPrefix: token.substring(0, 20) + '...',
                        tokenSuffix: token.substring(token.length - 20),
                        tokenParts: token.split('.').length,
                        headerLength: token.split('.')[0]?.length || 0,
                        payloadLength: token.split('.')[1]?.length || 0,
                        signatureLength: token.split('.')[2]?.length || 0
                    });
                    
                    // Test 5: Decode JWT payload (unsafe, just for debugging)
                    try {
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        addSection('JWT Payload Decoded', {
                            sub: payload.sub,
                            aud: payload.aud,
                            exp: payload.exp ? new Date(payload.exp * 1000).toISOString() : null,
                            iat: payload.iat ? new Date(payload.iat * 1000).toISOString() : null,
                            iss: payload.iss,
                            role: payload.user_role || 'Not found'
                        });
                    } catch (decodeError) {
                        addSection('JWT Decode Error', { error: decodeError.message }, 'error');
                    }
                } else {
                    addSection('JWT Token Missing', { message: 'No access_token in session' }, 'error');
                }
                
                // Test 6: Test API client auth (public function - keepalive)
                if (window.API) {
                    addSection('Testing API Client - Public Function (keepalive)', { status: 'Making keepalive request (no auth required)...' });
                    
                    try {
                        const response = await window.API.fetchEdge('keepalive', { 
                            method: 'GET',
                            requireAuth: false // Public function, no auth required
                        });
                        addSection('API Client keepalive Test', {
                            success: true,
                            response: response
                        }, 'success');
                    } catch (apiError) {
                        addSection('API Client keepalive Test', {
                            success: false,
                            error: apiError.message,
                            stack: apiError.stack
                        }, 'error');
                    }
                    
                    // Test 7: Test API client auth (public function - new function)
                    addSection('Testing API Client - Public Function (public_test)', { status: 'Making public_test request (no auth required)...' });
                    
                    try {
                        const response = await window.API.fetchEdge('public_test', { 
                            method: 'GET',
                            requireAuth: false // Public function, no auth required
                        });
                        addSection('API Client public_test Test', {
                            success: true,
                            response: response
                        }, 'success');
                    } catch (apiError) {
                        addSection('API Client public_test Test', {
                            success: false,
                            error: apiError.message,
                            stack: apiError.stack
                        }, 'error');
                    }
                    
                    // Test 8: Test API client auth (minimal function - no shared modules)
                    addSection('Testing API Client - Minimal Function (minimal_test)', { status: 'Making minimal_test request (no shared modules)...' });
                    
                    try {
                        const response = await window.API.fetchEdge('minimal_test', { 
                            method: 'GET',
                            requireAuth: false // Public function, no auth required
                        });
                        addSection('API Client minimal_test Test', {
                            success: true,
                            response: response
                        }, 'success');
                    } catch (apiError) {
                        addSection('API Client minimal_test Test', {
                            success: false,
                            error: apiError.message,
                            stack: apiError.stack
                        }, 'error');
                    }
                    
                    // Test 9: Direct fetch test (bypass API client completely)
                    addSection('Testing Direct Fetch - Minimal Function', { status: 'Making direct fetch request (no API client)...' });
                    
                    try {
                        const directResponse = await fetch('https://ubycoeyutauzjgxbozcm.supabase.co/functions/v1/minimal_test', {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                                // No auth headers, no apikey - completely clean
                            }
                        });
                        
                        const directData = await directResponse.json();
                        addSection('Direct Fetch minimal_test Test', {
                            success: directResponse.ok,
                            status: directResponse.status,
                            response: directData
                        }, directResponse.ok ? 'success' : 'error');
                    } catch (directError) {
                        addSection('Direct Fetch minimal_test Test', {
                            success: false,
                            error: directError.message,
                            stack: directError.stack
                        }, 'error');
                    }
                    
                    // Test 10: Direct fetch with user JWT Authorization header
                    addSection('Testing Direct Fetch - Minimal Function WITH User JWT', { status: 'Making direct fetch request WITH user JWT...' });
                    
                    try {
                        // Get a valid JWT token
                        const { data: { session } } = await window.SupabaseClient.getClient().auth.getSession();
                        const token = session?.access_token;
                        
                        if (token) {
                            console.log('Test 10: Using user token:', token.substring(0, 20) + '...');
                            
                            const authResponse = await fetch('https://ubycoeyutauzjgxbozcm.supabase.co/functions/v1/minimal_test', {
                                method: 'GET',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                    // Adding Authorization header to see if it gets stripped
                                }
                            });
                            
                            const authData = await authResponse.json();
                            addSection('Direct Fetch minimal_test WITH User JWT Test', {
                                success: authResponse.ok,
                                status: authResponse.status,
                                response: authData,
                                token_sent: token.substring(0, 20) + '...'
                            }, authResponse.ok ? 'success' : 'error');
                        } else {
                            addSection('Direct Fetch minimal_test WITH User JWT Test', {
                                success: false,
                                error: 'No token available for test'
                            }, 'error');
                        }
                    } catch (authError) {
                        addSection('Direct Fetch minimal_test WITH User JWT Test', {
                            success: false,
                            error: authError.message,
                            stack: authError.stack
                        }, 'error');
                    }
                    
                    // Test 11: Direct fetch with service role key (should bypass JWT validation)
                    addSection('Testing Direct Fetch - Minimal Function WITH Service Role', { status: 'Making direct fetch request WITH service role key...' });
                    
                    try {
                        // Use service role key (should bypass JWT validation)
                        const serviceRoleKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVieWNvZXl1dGF1empneGJvemNtIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTczODM5NzUxOSwiZXhwIjoyMDUzOTczNTE5fQ.NUqdlArOGnCUEXuQYummEgsJKHoTk3fUvBarKIagHMM';
                        
                        console.log('Test 11: Using service role key');
                        
                            const serviceResponse = await fetch('https://ubycoeyutauzjgxbozcm.supabase.co/functions/v1/minimal_test', {
                                method: 'GET',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${serviceRoleKey}`
                                    // Using service role key to bypass JWT validation
                                }
                            });
                            
                            const serviceData = await serviceResponse.json();
                            addSection('Direct Fetch minimal_test WITH Service Role Test', {
                                success: serviceResponse.ok,
                                status: serviceResponse.status,
                                response: serviceData,
                                token_type: 'service_role'
                            }, serviceResponse.ok ? 'success' : 'error');
                    } catch (serviceError) {
                        addSection('Direct Fetch minimal_test WITH Service Role Test', {
                            success: false,
                            error: serviceError.message,
                            stack: serviceError.stack
                        }, 'error');
                    }
                    
                    // Test 8: Test API client auth (protected function)
                    addSection('Testing API Client - Protected Function', { status: 'Making portfolio_snapshot request (auth required)...' });
                    
                    try {
                        const response = await window.API.fetchEdge('portfolio_snapshot', { 
                            method: 'GET',
                            requireAuth: true // Protected function, auth required
                        });
                        addSection('API Client Protected Function Test', {
                            success: true,
                            response: response
                        }, 'success');
                    } catch (apiError) {
                        addSection('API Client Protected Function Test', {
                            success: false,
                            error: apiError.message,
                            stack: apiError.stack
                        }, 'error');
                    }
                } else {
                    addSection('API Client Missing', { message: 'window.API not available' }, 'error');
                }
                
            } catch (error) {
                addSection('Debug Error', {
                    message: error.message,
                    stack: error.stack
                }, 'error');
            }
        }
        
        // Wait for everything to load
        setTimeout(debugJWT, 2000);
    </script>
</body>
</html>
